name: ë°°í¬

on:
  push:
    branches: [ "infra/cicd-test" ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
      - name: Gradle í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: chmod +x ./gradlew && ./gradlew clean test

  docker-build-push:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4



      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:latest
            ${{ vars.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:${{ github.sha }}

  deploy-ec2:
    needs: docker-build-push
    runs-on: ubuntu-latest
    steps:
      - name: ec2 ë°°í¬
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Docker ì„¤ì¹˜ì—¬ë¶€ í™•ì¸"
            if ! command -v docker &> /dev/null; then
              echo "Docker ë¯¸ì„¤ì¹˜ ìƒíƒœ... ì„¤ì¹˜ì‹œì‘"
              sudo apt-get update -y
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker  
              echo "Docker ì„¤ì¹˜ ì™„ë£Œ"
            else 
              echo "Docker ì„¤ì¹˜ ìƒíƒœ"
            fi
            
            echo "ğŸ“ .env íŒŒì¼ ìƒì„±"
            cat <<EOF > .env
            ${{ secrets.APP_ENV }}
            EOF
            
            sudo chmod 666 /var/run/docker.sock
            
            echo "ë„ì»¤ ì´ë¯¸ì§€ pull"
            sudo docker pull ${{ vars.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:latest
            
            echo "ğŸš¦ í˜„ì¬ ì„œë¹„ìŠ¤ ì¤‘ì¸ í¬íŠ¸ í™•ì¸"
            if docker ps --format '{{.Names}}' | grep -q 'blue'; then
              CURRENT="blue"
              NEXT="green"
              CURRENT_PORT=8080
              NEXT_PORT=8081
            else
              CURRENT="green"
              NEXT="blue"
              CURRENT_PORT=8081
              NEXT_PORT=8080
            fi
            
            echo "ğŸš¦ ì‹¤í–‰ ëŒ€ìƒ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ"
            sudo docker stop ${NEXT} || true
            
            echo "ğŸš¦ ì‹¤í–‰ ëŒ€ìƒ ì»¨í…Œì´ë„ˆ ì‚­ì œ"
            sudo docker rm ${NEXT} || true
            
            
            echo "ğŸ†• ìƒˆ ì»¨í…Œì´ë„ˆ ${NEXT_PORT} í¬íŠ¸ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤..."
            sudo docker run -d --restart unless-stopped --env-file .env -e SPRING_PROFILES_ACTIVE=prod --name ${NEXT} -p ${NEXT_PORT}:8080 ${{ vars.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:latest
            
            echo "ğŸ©º í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
            for i in {1..30}
              do
                echo "curl -s http://localhost:${NEXT_PORT}/health... ìš”ì²­ì¤‘..."
                STATUS=$(curl -s http://localhost:${NEXT_PORT}/health | grep OK)
              if [ -n "$STATUS" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ í†µê³¼"
                break
                fi
            sleep 5
            done
            
            if [ -z "$STATUS" ]; then
              echo "âŒ ìƒˆ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ ì¤‘ë‹¨"
              exit 1
            fi
            
            echo "ğŸ”§ Nginx í”„ë¡ì‹œ í¬íŠ¸ ë³€ê²½ ${CURRENT_PORT} â†’ ${NEXT_PORT}"
            sudo sed -i "s/${CURRENT_PORT}/${NEXT_PORT}/g" /etc/nginx/conf.d/app.conf
            sudo nginx -s reload
            
            
            echo "ğŸ§¹ ì´ì „ ì»¨í…Œì´ë„ˆ ${CURRENT_PORT} ì¢…ë£Œ"
            sudo docker stop ${CURRENT} || true
            
            echo "ğŸ§¹ ì´ì „ ì»¨í…Œì´ë„ˆ ${CURRENT_PORT} ì‚­ì œ"
            sudo docker rm ${CURRENT} || true
            
            echo "ğŸ‰ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ! í˜„ì¬ ì„œë¹„ìŠ¤ í¬íŠ¸: ${NEXT_PORT}"
