# 딱! 대기 (DDakDaegi)

---

## 🛒 프로젝트 소개

**딱! 대기**는 한정 수량의 상품을 세일하여 판매하는 상황을 가정한 주문/이벤트 API 서버입니다. 
특정 시간에 한정 수량의 상품을 판매할 때 발생할 수 있는 **동시성 문제**(초과 판매, 음수 재고, 중복 주문 등)를 방지하는 데 초점을 맞추고 있습니다.

- **상품 목록과 재고 수량 관리**
- **이벤트(프로모션) 등록 및 상품 할당**
- **주문 요청 시 재고 감소 및 주문 확정**
- **이벤트 종료 시 잔여 수량 원복**
- **동시성 제어(분산락)로 초과 판매, 중복 주문 방지**

---

## 🚩 주요 기능

### 1. 상품/재고 관리
- 상품 등록, 수정, 삭제, 조회
- 상품별 전체 재고 관리

### 2. 이벤트(프로모션) 관리
- 이벤트 등록/수정/삭제/조회
- 이벤트에 상품 할당 (이벤트별 별도 재고 할당)
- 이벤트 시작/종료 스케줄링 및 상태 관리
- 이벤트 종료 시 남은 재고를 원래 상품 재고로 복구

### 3. 주문 처리
- 사용자는 이벤트에 등록된 상품 중 최소 1개 이상, 재고 1개 이상인 상품만 주문 가능
- 주문 시 이벤트 상품 재고 감소 및 주문 확정
- 결제는 하나의 이벤트에서만 가능
- 재고 부족 시 결제/주문 취소

### 4. 동시성 제어
- 인기 상품 세일 시작 시 짧은 시간(수백 ms) 내 다수의 주문 요청이 몰려도 **초과 판매/음수 재고/중복 주문**이 발생하지 않도록 분산락(Redis 기반 Redisson Lock, Lettuce Lock 등) 적용
- 여러 서버 인스턴스/프로세스 환경에서도 안전하게 재고 감소 처리

---

## ⚠️ 동작 시나리오 및 동시성 문제 예시

> 인기 상품 세일 시작 시, 200ms 이내에 수백~수천 건의 주문 요청이 동시에 들어올 수 있음
> - 재고 감소 과정에서 동시성 제어가 없으면 **음수 재고** 또는 **초과 판매** 발생 가능
> - 동일 사용자가 중복 주문을 보내거나, 여러 서버 인스턴스에서 동시에 같은 상품 재고를 감소시키는 경우 **race condition** 발생 가능
> - 본 프로젝트는 이러한 문제를 **분산락 기반 동시성 제어**로 해결

---

## 🛠️ 기술 스택

- Java 17
- Spring Boot 3.x
- Spring Data JPA, Spring Security, Spring Validation
- Redis, Redisson, Lettuce
- MySQL, H2 (테스트)
- QueryDSL
- JWT 인증/인가

---

## 🗂️ 주요 도메인 구조

| 도메인              | 설명                                      |
|---------------------|-------------------------------------------|
| **Product**         | 상품, 전체 재고 관리                      |
| **Promotion**       | 이벤트(프로모션), 기간/상태/배너 등 관리   |
| **PromotionProduct**| 이벤트에 할당된 상품, 이벤트별 재고/할인정책/구매제한 등 관리 |
| **Order**           | 주문, 주문 상태/총액/회원 연관            |
| **OrderPromotionProduct** | 주문-이벤트상품 매핑, 수량 관리      |
| **Member**          | 회원, 인증/권한 관리                      |

---

## 🔒 동시성 제어(분산락) 방식

- 주문/재고 감소 시 Redisson 기반 분산락(`@RedissonLocked` AOP, RedissonLockStockFacade 등) 적용
- 락을 획득한 후에만 재고 감소 및 주문 확정 로직 실행
- 락 획득 실패 시 주문 불가(LOCK_ACQUISITION_FAILED)
- 이벤트별, 상품별로 락을 분리하여 deadlock/성능 저하 방지

---

## 📚 API 개요

### 상품(Product)
- `POST /api/v1/products` : 상품 등록
- `GET /api/v1/products` : 상품 목록 조회
- `PATCH /api/v1/products/{productId}` : 상품 정보 수정
- `DELETE /api/v1/products/delete/{productId}` : 상품 삭제(soft delete)

### 이벤트(Promotion)
- `POST /api/v1/promotions` : 이벤트 등록(상품 할당 포함)
- `GET /api/v1/promotions` : 이벤트 목록 조회
- `PATCH /api/v1/promotions/{id}` : 이벤트 정보 수정
- `DELETE /api/v1/promotions/{id}` : 이벤트 삭제

### 주문(Order)
- `POST /api/v1/orders` : 주문 생성(이벤트 상품 재고 감소, 동시성 제어)
- `GET /api/v1/orders/{orderId}` : 주문 상세 조회
- `PATCH /api/v1/orders/{orderId}` : 주문 취소(재고 복구)

---

## 🚨 예외 및 제약

- 이벤트에 등록되는 상품의 수량은 전체 재고에서 할당
- 최소 1개 이상의 상품, 1개 이상의 재고가 있어야 주문 가능
- 이벤트 종료 시 잔여 수량은 원래 상품 재고로 복구
- 결제/주문은 하나의 이벤트에서만 가능
- 재고 부족 시 결제/주문 취소

---

## 🎯 프로젝트 목적

- **실제 대규모 트래픽 환경에서 발생할 수 있는 동시성 문제(초과 판매, 음수 재고, 중복 주문 등)를 안전하게 제어하는 API 설계/구현**
- **분산락, 트랜잭션, 이벤트/재고 관리 등 실전형 백엔드 설계 경험 제공**

---

## 🚀 실행 방법

1. `application.yml`에 DB/Redis 등 환경 변수 설정
2. `./gradlew build`
3. `java -jar build/libs/ddakdaegi-0.0.1-SNAPSHOT.jar`
4. API 문서는 Swagger 또는 Postman Collection 참고

---

> 필요에 따라 예시 요청/응답, 상세 API 명세, ERD, 락 적용 흐름도 등을 추가할 수 있습니다. 